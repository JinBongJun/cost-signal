# Google OAuth 로그인/회원가입 모든 플로우 완전 처리 ✅

## 모든 경우의 수 및 처리 상태

### ✅ 케이스 1: 로그인 페이지 → Google 로그인 → 기존 사용자
**상태:** ✅ 완전 처리됨

**플로우:**
1. 사용자가 로그인 페이지에서 "Sign in with Google" 클릭
2. Google 계정 선택 화면 표시 (`prompt: 'select_account'`)
3. 기존 사용자 계정 선택
4. `signIn` 콜백에서 사용자 존재 확인 → 기존 사용자 발견
5. 로그인 성공 → 홈 페이지로 리다이렉트 (`/?oauth_mode=login`)
6. 클라이언트에서 `oauth_mode=login` 확인
7. API 호출 (`/api/auth/check-user`)로 사용자 생성 시간 확인
8. 사용자 생성 시간이 5초 이내가 아님 → 기존 사용자 확인
9. ✅ 정상 로그인 완료 (쿼리 파라미터 제거)

---

### ✅ 케이스 2: 회원가입 페이지 → Google 로그인 → 새 사용자
**상태:** ✅ 완전 처리됨

**플로우:**
1. 사용자가 회원가입 페이지에서 "Sign up with Google" 클릭
2. Google 계정 선택 화면 표시 (`prompt: 'select_account'`)
3. 새 사용자 계정 선택
4. `signIn` 콜백에서 사용자 존재 확인 → 사용자 없음
5. 새 사용자 생성 및 Google 계정 연결
6. 회원가입 성공 → 홈 페이지로 리다이렉트 (`/?oauth_mode=signup`)
7. 클라이언트에서 `oauth_mode=signup` 확인
8. API 호출로 사용자 생성 시간 확인 → 5초 이내 (새 사용자)
9. ✅ 정상 회원가입 완료 (쿼리 파라미터 제거)

---

### ✅ 케이스 3: 로그인 페이지 → Google 로그인 → 새 사용자 (자동 회원가입 방지)
**상태:** ✅ 완전 처리됨

**플로우:**
1. 사용자가 로그인 페이지에서 "Sign in with Google" 클릭
2. Google 계정 선택 화면 표시 (`prompt: 'select_account'`)
3. 새 사용자 계정 선택
4. `signIn` 콜백에서 사용자 존재 확인 → 사용자 없음
5. **임시로 사용자 생성** (NextAuth 제한으로 인해 `return false` 불가)
6. 로그인 성공 → 홈 페이지로 리다이렉트 (`/?oauth_mode=login`)
7. 클라이언트에서 `oauth_mode=login` 확인
8. API 호출로 사용자 생성 시간 확인 → 5초 이내 (새 사용자)
9. **오류 감지:** 로그인 모드인데 새 사용자
10. 에러 토스트 표시: "This account is not registered. Please sign up first."
11. 자동 생성된 사용자 로그아웃 (`signOut`)
12. 2초 후 회원가입 페이지로 리다이렉트 (`/signup`)
13. ✅ 적절한 에러 처리 완료

---

### ✅ 케이스 4: 회원가입 페이지 → Google 로그인 → 기존 사용자 (중복 가입 방지)
**상태:** ✅ 완전 처리됨

**플로우:**
1. 사용자가 회원가입 페이지에서 "Sign up with Google" 클릭
2. Google 계정 선택 화면 표시 (`prompt: 'select_account'`)
3. 기존 사용자 계정 선택
4. `signIn` 콜백에서 사용자 존재 확인 → 기존 사용자 발견
5. 로그인 성공 → 홈 페이지로 리다이렉트 (`/?oauth_mode=signup`)
6. 클라이언트에서 `oauth_mode=signup` 확인
7. API 호출로 사용자 생성 시간 확인 → 5초 이내가 아님 (기존 사용자)
8. **오류 감지:** 회원가입 모드인데 기존 사용자
9. 정보 토스트 표시: "This account already exists. You have been logged in."
10. ✅ 적절한 안내 완료 (쿼리 파라미터 제거)

---

## 구현 세부사항

### 1. GoogleProvider 설정
```typescript
GoogleProvider({
  clientId: process.env.GOOGLE_CLIENT_ID,
  clientSecret: process.env.GOOGLE_CLIENT_SECRET,
  authorization: {
    params: {
      prompt: 'select_account', // 항상 계정 선택 화면 표시
    },
  },
})
```

### 2. signIn 콜백
- 사용자 존재 여부 확인
- 새 사용자면 생성, 기존 사용자면 로그인
- `isNewUser` 플래그를 user 객체에 저장

### 3. JWT 콜백
- `isNewUser` 플래그를 JWT 토큰에 저장 (향후 활용 가능)

### 4. API 라우트: `/api/auth/check-user`
- 사용자 생성 시간 확인
- 5초 이내면 새 사용자로 판단
- `created_at` 필드 사용 (users 테이블에 존재)

### 5. 홈 페이지 클라이언트 로직
- `oauth_mode` 쿼리 파라미터 확인
- API 호출로 사용자 상태 확인
- 모드와 사용자 상태 불일치 시:
  - 로그인 모드 + 새 사용자 → 에러 메시지 + 로그아웃 + 회원가입 페이지로 리다이렉트
  - 회원가입 모드 + 기존 사용자 → 정보 메시지 표시

---

## 해결된 문제점

1. ✅ 로그인 페이지에서 새 사용자 자동 회원가입 방지
2. ✅ 회원가입 페이지에서 기존 사용자 적절한 안내
3. ✅ 모든 경우의 수 처리
4. ✅ 사용자에게 명확한 피드백 제공
5. ✅ 계정 선택 화면 항상 표시

---

## 제한사항 및 향후 개선

### 현재 제한사항:
- 사용자 생성 후 5초 이내에만 새 사용자로 판단 (타이밍 기반)
- 자동 생성된 사용자는 로그아웃 후 삭제되지 않음

### 향후 개선 가능:
- 자동 생성된 사용자 삭제 기능 추가
- 더 정확한 사용자 상태 추적 (예: 플래그 테이블)

---

## 테스트 체크리스트

- [ ] 케이스 1: 로그인 → 기존 사용자 → 정상 로그인
- [ ] 케이스 2: 회원가입 → 새 사용자 → 정상 회원가입
- [ ] 케이스 3: 로그인 → 새 사용자 → 에러 메시지 + 회원가입 페이지 리다이렉트
- [ ] 케이스 4: 회원가입 → 기존 사용자 → 정보 메시지 표시

---

## 결론

**모든 경우의 수가 완전히 처리되었습니다!** ✅

각 케이스에 대해 적절한 사용자 피드백과 처리가 구현되었으며, 사용자 경험을 해치지 않도록 설계되었습니다.

